<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDS Model Viewer</title>
  <meta name="description" content="Panzer Dragoon Saga Model Viewer — Raw MCB/CGB data viewer">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a0a0f;
      --bg-panel: #111118;
      --bg-card: #1a1a24;
      --bg-hover: #22223a;
      --bg-active: #2a2a4a;
      --border: #2a2a3a;
      --border-bright: #3a3a5a;
      --text-primary: #e8e8f0;
      --text-secondary: #8888aa;
      --text-dim: #555577;
      --accent: #6c8cff;
      --accent-glow: #4a6aff;
      --accent-subtle: #2a3a6a;
      --green: #5ce0a0;
      --red: #ff6b6b;
      --orange: #ffaa44;
      --cyan: #44ddee;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* ── Left Panel: Model Browser ── */
    #sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    #sidebar-header h1 {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--accent);
    }

    #sidebar-header p {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    #search-box {
      margin: 12px 16px 8px;
      padding: 8px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 12px;
      outline: none;
      width: calc(100% - 32px);
    }

    #search-box:focus {
      border-color: var(--accent);
    }

    #search-box::placeholder {
      color: var(--text-dim);
    }

    #model-list {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
    }

    .category-header {
      padding: 8px 16px 4px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
      position: sticky;
      top: 0;
      background: var(--bg-panel);
    }

    .model-item {
      padding: 6px 16px 6px 24px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s;
    }

    .model-item:hover {
      background: var(--bg-hover);
    }

    .model-item.active {
      background: var(--bg-active);
      color: var(--accent);
    }

    .model-item .name {
      font-weight: 500;
    }

    .model-item .stats {
      font-size: 10px;
      color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace;
    }

    /* ── Main Area ── */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* ── Toolbar ── */
    #toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      min-height: 44px;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 8px;
      border-right: 1px solid var(--border);
    }

    .toolbar-group:last-child {
      border-right: none;
    }

    .toolbar-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 4px;
    }

    .btn {
      padding: 5px 10px;
      font-size: 11px;
      font-family: inherit;
      font-weight: 500;
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-bright);
    }

    .btn.active {
      background: var(--accent-subtle);
      color: var(--accent);
      border-color: var(--accent);
    }

    .btn-icon {
      width: 30px;
      padding: 5px;
      text-align: center;
      font-size: 14px;
    }

    /* ── Canvas ── */
    #viewport {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    #glcanvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(10, 10, 15, 0.85);
      z-index: 10;
    }

    #loading-overlay .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      gap: 8px;
    }

    #empty-state .icon {
      font-size: 48px;
      opacity: 0.3;
    }

    #empty-state p {
      font-size: 13px;
    }

    /* ── Bottom Bar: Animation Controls ── */
    #anim-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-panel);
      border-top: 1px solid var(--border);
      min-height: 44px;
    }

    #anim-select {
      padding: 5px 8px;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
      min-width: 180px;
    }

    #frame-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
      min-width: 100px;
      text-align: right;
    }

    #speed-slider {
      width: 80px;
      accent-color: var(--accent);
    }

    #speed-label {
      font-size: 10px;
      color: var(--text-dim);
      min-width: 35px;
    }

    /* ── Right Panel: Info ── */
    #info-panel {
      width: 240px;
      min-width: 240px;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      padding: 16px;
      overflow-y: auto;
      display: none;
    }

    #info-panel.visible {
      display: block;
    }

    .info-section {
      margin-bottom: 16px;
    }

    .info-section h3 {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      padding: 3px 0;
    }

    .info-row .label {
      color: var(--text-secondary);
    }

    .info-row .value {
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
    }

    /* ── Scrollbar Styling ── */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-bright);
    }

    /* ── Hidden ── */
    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>

  <!-- Left Panel: Model Browser -->
  <div id="sidebar">
    <div id="sidebar-header">
      <h1>PDS Model Viewer</h1>
      <p id="model-count">Loading manifest...</p>
    </div>
    <input type="text" id="search-box" placeholder="Search models...">
    <div id="model-list"></div>
  </div>

  <!-- Main Area -->
  <div id="main">
    <!-- Toolbar -->
    <div id="toolbar">
      <div class="toolbar-group">
        <span class="toolbar-label">View</span>
        <button class="btn active" id="btn-textured" onclick="toggleView('textured')">Textured</button>
        <button class="btn" id="btn-wireframe" onclick="toggleView('wireframe')">Wireframe</button>
        <button class="btn" id="btn-bones" onclick="toggleView('bones')">Bones</button>
      </div>
      <div class="toolbar-group">
        <span class="toolbar-label">Camera</span>
        <button class="btn btn-icon" onclick="resetCamera()" title="Reset Camera">⌂</button>
      </div>
      <div class="toolbar-group">
        <button class="btn" id="btn-info" onclick="toggleInfoPanel()">Info</button>
      </div>
    </div>

    <!-- Viewport -->
    <div id="viewport">
      <canvas id="glcanvas"></canvas>
      <div id="empty-state">
        <div class="icon">◇</div>
        <p>Select a model to view</p>
      </div>
      <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Animation Bar -->
    <div id="anim-bar">
      <select id="anim-select" onchange="selectAnimation(this.value)">
        <option value="-1">No animation</option>
      </select>
      <button class="btn btn-icon" onclick="stepBack()" title="Step Back">⏮</button>
      <button class="btn btn-icon" id="btn-play" onclick="togglePlay()" title="Play/Pause">▶</button>
      <button class="btn btn-icon" onclick="stepForward()" title="Step Forward">⏭</button>
      <span id="frame-display">Frame: 0 / 0</span>
      <div style="flex:1"></div>
      <span id="speed-label">1.0×</span>
      <input type="range" id="speed-slider" min="0.1" max="3" step="0.1" value="1" oninput="setSpeed(this.value)">
    </div>
  </div>

  <!-- Right Panel: Info -->
  <div id="info-panel">
    <div class="info-section">
      <h3>Model Info</h3>
      <div id="info-model-data"></div>
    </div>
    <div class="info-section">
      <h3>Pointer Table</h3>
      <div id="info-ptr-data"></div>
    </div>
    <div class="info-section">
      <h3>Animation</h3>
      <div id="info-anim-data"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="viewer_animation.js"></script>
  <script src="viewer_renderer.js"></script>
  <script>

    // ── Configuration ──────────────────────────────────────────────────────────
    const DATA_BASE = '../output/raw';

    // ── State ──────────────────────────────────────────────────────────────────
    let manifest = null;
    let renderer = null;
    let animController = null;
    let currentModelName = null;
    let currentStructure = null;
    let currentMCB = null;
    let currentCGB = null;
    let animations = [];
    let animFrameId = null;
    let playbackSpeed = 1.0;
    let lastFrameTime = 0;
    let frameAccumulator = 0;

    // ── Initialization ─────────────────────────────────────────────────────────

    async function init() {
      // Init renderer (non-fatal — sidebar should still work without WebGL)
      const canvas = document.getElementById('glcanvas');
      try {
        renderer = new (window.PDSRenderer.PDSRenderer)(canvas);
        resizeCanvas();
        setupMouseControls(canvas);
      } catch (e) {
        console.warn('WebGL renderer init failed:', e.message);
        document.getElementById('empty-state').innerHTML =
          '<div class="icon">⚠</div><p>WebGL not available — model list still works</p>';
      }
      window.addEventListener('resize', resizeCanvas);

      // Load manifest
      try {
        const resp = await fetch(`${DATA_BASE}/manifest.json`);
        manifest = await resp.json();
        buildModelList();
        document.getElementById('model-count').textContent =
          `${manifest.models.length} models · ${manifest.credits ? 'Azel ♥' : ''}`;
      } catch (e) {
        document.getElementById('model-count').textContent = 'Failed to load manifest';
        console.error('Manifest load failed:', e);
      }

      if (renderer) renderLoop();
    }

    function resizeCanvas() {
      const canvas = document.getElementById('glcanvas');
      const rect = canvas.parentElement.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      if (renderer) {
        renderer.resize(canvas.width, canvas.height);
      }
    }

    // ── Model List ─────────────────────────────────────────────────────────────

    function buildModelList() {
      const list = document.getElementById('model-list');
      list.innerHTML = '';

      const categories = manifest.categories;
      const catOrder = ['Dragons', 'Characters', 'NPCs', 'Fields', 'Maps', 'Objects', 'Overworld', 'Other'];

      for (const cat of catOrder) {
        if (!categories[cat] || categories[cat].length === 0) continue;

        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = `${cat} (${categories[cat].length})`;
        list.appendChild(header);

        for (const name of categories[cat].sort()) {
          const entry = manifest.models.find(m => m.name === name);
          const item = document.createElement('div');
          item.className = 'model-item';
          item.dataset.name = name;
          item.innerHTML = `
                <span class="name">${name}</span>
                <span class="stats">${entry?.animations || 0}a</span>
            `;
          item.onclick = () => loadModel(name);
          list.appendChild(item);
        }
      }
    }

    function filterModelList(query) {
      const items = document.querySelectorAll('.model-item');
      const headers = document.querySelectorAll('.category-header');
      const q = query.toLowerCase();

      headers.forEach(h => h.style.display = q ? 'none' : '');
      items.forEach(item => {
        const name = item.dataset.name.toLowerCase();
        item.style.display = name.includes(q) ? '' : 'none';
      });
    }

    document.getElementById('search-box').addEventListener('input', e => filterModelList(e.target.value));

    // ── Model Loading ──────────────────────────────────────────────────────────

    async function loadModel(name) {
      // Update UI
      document.querySelectorAll('.model-item').forEach(el => {
        el.classList.toggle('active', el.dataset.name === name);
      });
      document.getElementById('empty-state').classList.add('hidden');
      document.getElementById('loading-overlay').classList.remove('hidden');

      currentModelName = name;

      try {
        // Fetch raw files
        const [mcbResp, cgbResp, structResp] = await Promise.all([
          fetch(`${DATA_BASE}/${name}.mcb.bin`),
          fetch(`${DATA_BASE}/${name}.cgb.bin`).catch(() => null),
          fetch(`${DATA_BASE}/${name}_structure.json`),
        ]);

        currentMCB = new Uint8Array(await mcbResp.arrayBuffer());
        currentCGB = cgbResp ? new Uint8Array(await (cgbResp).arrayBuffer()) : new Uint8Array(0);
        currentStructure = await structResp.json();

        // Load into renderer
        renderer.loadModel(currentMCB, currentCGB, currentStructure);

        // Parse animations
        animations = [];
        for (const entry of currentStructure.pointerTable) {
          if (entry.type === 'animation') {
            const anim = window.PDSAnimation.parseAnimationData(currentMCB, entry.offset);
            if (anim) {
              animations.push({ slot: entry.slot, data: anim });
            }
          }
        }

        // Build animation dropdown
        const select = document.getElementById('anim-select');
        select.innerHTML = '<option value="-1">No animation</option>';
        animations.forEach((a, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `Anim ${i} (slot ${a.slot}, ${a.data.numFrames}f, mode ${a.data.mode})`;
          select.appendChild(opt);
        });

        // Setup animation controller
        if (currentStructure.hierarchies.length > 0) {
          const hier = currentStructure.hierarchies[0];
          // Find first pose
          let defaultPose = [];
          for (const entry of currentStructure.pointerTable) {
            if (entry.type === 'pose') {
              defaultPose = window.PDSAnimation.parseStaticPose(currentMCB, entry.offset, hier.boneCount);
              break;
            }
          }

          animController = new (window.PDSAnimation.AnimationController)(hier.boneCount, defaultPose);

          // Auto-play first animation
          if (animations.length > 0) {
            select.value = '0';
            selectAnimation('0');
          } else {
            // Apply default pose
            updateRendererPose();
          }
        } else {
          animController = null;
        }

        updateInfoPanel();

      } catch (e) {
        console.error('Load failed:', e);
      }

      document.getElementById('loading-overlay').classList.add('hidden');
    }

    // ── Animation Controls ─────────────────────────────────────────────────────

    function selectAnimation(value) {
      const idx = parseInt(value);
      if (idx < 0 || idx >= animations.length || !animController) {
        if (animController) {
          animController.playing = false;
          animController.currentAnimation = null;
        }
        document.getElementById('btn-play').textContent = '▶';
        updateFrameDisplay();
        return;
      }

      animController.setAnimation(animations[idx].data);
      animController.loop = true;
      document.getElementById('btn-play').textContent = '⏸';
      updateRendererPose();
      updateFrameDisplay();
      updateAnimInfo(idx);
    }

    function togglePlay() {
      if (!animController || !animController.currentAnimation) return;
      animController.playing = !animController.playing;
      document.getElementById('btn-play').textContent = animController.playing ? '⏸' : '▶';
    }

    function stepForward() {
      if (!animController || !animController.currentAnimation) return;
      animController.playing = false;
      document.getElementById('btn-play').textContent = '▶';
      animController.stepAnimation();
      updateRendererPose();
      updateFrameDisplay();
    }

    function stepBack() {
      if (!animController || !animController.currentAnimation) return;
      // Reset and step to current frame - 1
      const targetFrame = Math.max(0, animController.currentFrame - 2);
      const animIdx = parseInt(document.getElementById('anim-select').value);
      if (animIdx >= 0) {
        animController.setAnimation(animations[animIdx].data);
        for (let i = 0; i < targetFrame; i++) {
          animController.stepAnimation();
        }
        animController.playing = false;
        document.getElementById('btn-play').textContent = '▶';
        updateRendererPose();
        updateFrameDisplay();
      }
    }

    function setSpeed(value) {
      playbackSpeed = parseFloat(value);
      document.getElementById('speed-label').textContent = `${playbackSpeed.toFixed(1)}×`;
    }

    function updateFrameDisplay() {
      const el = document.getElementById('frame-display');
      if (!animController || !animController.currentAnimation) {
        el.textContent = 'Frame: — / —';
        return;
      }
      el.textContent = `Frame: ${animController.currentFrame} / ${animController.currentAnimation.numFrames}`;
    }

    function updateRendererPose() {
      if (!animController || !renderer.currentHierarchy) return;
      const pose = animController.getPoseForRendering();
      renderer.buildAnimatedMeshBuffers(pose);
    }

    // ── View Controls ──────────────────────────────────────────────────────────

    function toggleView(mode) {
      if (mode === 'textured') {
        renderer.showTexture = !renderer.showTexture;
        document.getElementById('btn-textured').classList.toggle('active', renderer.showTexture);
      } else if (mode === 'wireframe') {
        renderer.showWireframe = !renderer.showWireframe;
        document.getElementById('btn-wireframe').classList.toggle('active', renderer.showWireframe);
      } else if (mode === 'bones') {
        renderer.showBones = !renderer.showBones;
        document.getElementById('btn-bones').classList.toggle('active', renderer.showBones);
      }
    }

    function resetCamera() {
      renderer.cameraRotX = 0.3;
      renderer.cameraRotY = 0;
      renderer.cameraPanX = 0;
      renderer.cameraPanY = 0;
      if (renderer.currentModels) {
        const models = Object.values(renderer.currentModels);
        renderer._autoFitCamera(models);
      }
    }

    function toggleInfoPanel() {
      const panel = document.getElementById('info-panel');
      panel.classList.toggle('visible');
      document.getElementById('btn-info').classList.toggle('active');
      resizeCanvas();
    }

    // ── Info Panel ─────────────────────────────────────────────────────────────

    function updateInfoPanel() {
      if (!currentStructure) return;

      const s = currentStructure;
      const modelInfo = document.getElementById('info-model-data');
      modelInfo.innerHTML = `
        <div class="info-row"><span class="label">Name</span><span class="value">${s.name}</span></div>
        <div class="info-row"><span class="label">MCB Size</span><span class="value">${formatSize(s.mcbSize)}</span></div>
        <div class="info-row"><span class="label">CGB Size</span><span class="value">${formatSize(s.cgbSize)}</span></div>
        <div class="info-row"><span class="label">Ptr Slots</span><span class="value">${s.pointerTableSlots}</span></div>
        <div class="info-row"><span class="label">Models</span><span class="value">${s.modelSlots.length}</span></div>
        <div class="info-row"><span class="label">Hierarchies</span><span class="value">${s.hierarchies.length}</span></div>
        <div class="info-row"><span class="label">Animations</span><span class="value">${s.animationSlots.length}</span></div>
        <div class="info-row"><span class="label">Poses</span><span class="value">${s.poseSlots.length}</span></div>
    `;

      const ptrInfo = document.getElementById('info-ptr-data');
      const counts = s.typeCounts || {};
      ptrInfo.innerHTML = Object.entries(counts)
        .filter(([k]) => k !== 'zero')
        .map(([k, v]) => `<div class="info-row"><span class="label">${k}</span><span class="value">${v}</span></div>`)
        .join('');
    }

    function updateAnimInfo(idx) {
      if (idx < 0 || idx >= animations.length) return;
      const a = animations[idx].data;
      const animInfo = document.getElementById('info-anim-data');
      animInfo.innerHTML = `
        <div class="info-row"><span class="label">Slot</span><span class="value">${animations[idx].slot}</span></div>
        <div class="info-row"><span class="label">Mode</span><span class="value">${a.mode}</span></div>
        <div class="info-row"><span class="label">Bones</span><span class="value">${a.numBones}</span></div>
        <div class="info-row"><span class="label">Frames</span><span class="value">${a.numFrames}</span></div>
        <div class="info-row"><span class="label">Flags</span><span class="value">0x${a.flags.toString(16).toUpperCase()}</span></div>
        <div class="info-row"><span class="label">Position</span><span class="value">${a.hasPosition ? '✓' : '—'}</span></div>
        <div class="info-row"><span class="label">Rotation</span><span class="value">${a.hasRotation ? '✓' : '—'}</span></div>
        <div class="info-row"><span class="label">Scale</span><span class="value">${a.hasScale ? '✓' : '—'}</span></div>
    `;
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ── Mouse Controls ─────────────────────────────────────────────────────────

    function setupMouseControls(canvas) {
      let isDragging = false;
      let isPanning = false;
      let lastX = 0, lastY = 0;

      canvas.addEventListener('mousedown', e => {
        if (e.button === 0) isDragging = true;
        if (e.button === 1 || e.button === 2) isPanning = true;
        lastX = e.clientX;
        lastY = e.clientY;
        e.preventDefault();
      });

      window.addEventListener('mouseup', () => {
        isDragging = false;
        isPanning = false;
      });

      window.addEventListener('mousemove', e => {
        const dx = e.clientX - lastX;
        const dy = e.clientY - lastY;
        lastX = e.clientX;
        lastY = e.clientY;

        if (isDragging) {
          renderer.cameraRotY += dx * 0.01;
          renderer.cameraRotX += dy * 0.01;
          renderer.cameraRotX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, renderer.cameraRotX));
        }
        if (isPanning) {
          renderer.cameraPanX += dx * renderer.cameraDistance * 0.001;
          renderer.cameraPanY -= dy * renderer.cameraDistance * 0.001;
        }
      });

      canvas.addEventListener('wheel', e => {
        renderer.cameraDistance *= e.deltaY > 0 ? 1.1 : 0.9;
        renderer.cameraDistance = Math.max(1, Math.min(10000, renderer.cameraDistance));
        e.preventDefault();
      });

      canvas.addEventListener('contextmenu', e => e.preventDefault());
    }

    // ── Render Loop ────────────────────────────────────────────────────────────

    function renderLoop(timestamp = 0) {
      animFrameId = requestAnimationFrame(renderLoop);

      // Animation stepping at ~30fps (Saturn frame rate) × speed
      const TARGET_FPS = 30;
      const delta = timestamp - lastFrameTime;
      lastFrameTime = timestamp;

      if (animController && animController.playing && animController.currentAnimation) {
        frameAccumulator += delta * playbackSpeed;
        const frameInterval = 1000 / TARGET_FPS;

        while (frameAccumulator >= frameInterval) {
          frameAccumulator -= frameInterval;
          animController.stepAnimation();
        }

        updateRendererPose();
        updateFrameDisplay();
      }

      renderer.render();
    }

    // ── Keyboard Shortcuts ─────────────────────────────────────────────────────

    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      switch (e.key) {
        case ' ':
          e.preventDefault();
          togglePlay();
          break;
        case 'ArrowRight':
          stepForward();
          break;
        case 'ArrowLeft':
          stepBack();
          break;
        case 'w':
          toggleView('wireframe');
          break;
        case 'b':
          toggleView('bones');
          break;
        case 't':
          toggleView('textured');
          break;
        case 'r':
          resetCamera();
          break;
        case 'i':
          toggleInfoPanel();
          break;
      }
    });

    // ── Start ──────────────────────────────────────────────────────────────────
    init();
  </script>
</body>

</html>